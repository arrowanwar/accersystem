<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Field Office ER - Data Entry</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">
  <h2 class="mb-4">Field Office ER - Data Entry</h2>

  <!-- Form Card -->
  <div class="card shadow-lg">
    <div class="card-body">
      <form id="fieldOfficeErForm">

        <!-- HQ ER -->
        <div class="mb-3">
          <label for="hq_er_no" class="form-label">HQ ER No</label>
          <select class="form-select" id="hq_er_id" required></select>
        </div>

        <!-- Enquiry Officer -->
        <div class="mb-3">
          <label for="enq_officer_id" class="form-label">Enquiry Officer</label>
          <select class="form-select" id="enq_officer_id" required></select>
        </div>

        <!-- Endorsement -->
        <div class="mb-3">
          <label for="endorsement_id" class="form-label">Endorsement</label>
          <select class="form-select" id="endorsement_id" required></select>
        </div>

        <!-- Accused Service Info -->
        <div class="mb-3">
          <label for="accused_service_info_id" class="form-label">Accused Service</label>
          <select class="form-select" id="accused_service_info_id" required></select>
        </div>

        <!-- Accused Present Address -->
        <div class="mb-3">
          <label for="accused_present_add_info_id" class="form-label">Accused Present Address</label>
          <select class="form-select" id="accused_present_add_info_id" required></select>
        </div>

        <!-- Accused Permanent Address -->
        <div class="mb-3">
          <label for="accused_permanent_add_info_id" class="form-label">Accused Permanent Address</label>
          <select class="form-select" id="accused_permanent_add_info_id" required></select>
        </div>

        <button type="submit" class="btn btn-primary">Save Record</button>
      </form>
    </div>
  </div>

  <!-- Records Table -->
  <div class="card shadow-lg mt-4">
    <div class="card-body">
      <h5>Saved Records</h5>
      <table class="table table-bordered table-striped mt-3">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>HQ ER</th>
            <th>Officer</th>
            <th>Endorsement</th>
            <th>Accused Service</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="recordsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Bootstrap Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
  <div id="toast" class="toast align-items-center text-bg-primary border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Hello, world!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const API_BASE = "http://127.0.0.1:8000/api"; // adjust if needed

// Bootstrap toast helper
function showToast(message, type="primary") {
  const toastEl = document.getElementById('toast');
  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  document.getElementById('toastMessage').textContent = message;
  const toast = new bootstrap.Toast(toastEl);
  toast.show();
}

// Load dropdown data
async function loadDropdowns() {
  try {
    const [hqRes, offRes, endRes, servRes, presRes, permRes] = await Promise.all([
      axios.get(`${API_BASE}/hq-ers`),
      axios.get(`${API_BASE}/officers`),
      axios.get(`${API_BASE}/endorse-orders`),
      axios.get(`${API_BASE}/accused/services`),
      axios.get(`${API_BASE}/accused/present`),
      axios.get(`${API_BASE}/accused/permanent`),
    ]);

    fillDropdown('hq_er_id', hqRes.data.data, 'hq_er_no');
    fillDropdown('enq_officer_id', offRes.data.data, 'name');
    fillDropdown('endorsement_id', endRes.data.data, 'memo_no');
    fillDropdown('accused_service_info_id', servRes.data.data, 'name');
    fillDropdown('accused_present_add_info_id', presRes.data.data, 'id');
    fillDropdown('accused_permanent_add_info_id', permRes.data.data, 'id');

  } catch (err) {
    console.error(err);
    showToast("Error loading dropdowns", "danger");
  }
}

// Helper to fill select options
function fillDropdown(selectId, items, labelField) {
  const select = document.getElementById(selectId);
  select.innerHTML = `<option value="">Select...</option>`;
  items.forEach(item => {
    select.innerHTML += `<option value="${item.id ?? item[labelField]}">${item[labelField]}</option>`;
  });
}

// Load records table
async function loadRecords() {
  try {
    const res = await axios.get(`${API_BASE}/field-office-ers`);
    const tbody = document.getElementById('recordsTable');
    tbody.innerHTML = "";
    res.data.data.forEach(r => {
      tbody.innerHTML += `
        <tr>
          <td>${r.id}</td>
          <td>${r.hq_er?.hq_er_no ?? ''}</td>
          <td>${r.enquiry_officer?.name ?? ''}</td>
          <td>${r.endorsement?.memo_no ?? ''}</td>
          <td>${r.accused_service?.name ?? ''}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteRecord(${r.id})">Delete</button>
          </td>
        </tr>`;
    });
  } catch (err) {
    console.error(err);
    showToast("Error loading records", "danger");
  }
}

// Handle form submit
document.getElementById("fieldOfficeErForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = {
    hq_er_no: document.getElementById("hq_er_id").value,
    enq_officer_id: document.getElementById("enq_officer_id").value,
    endorsement_id: document.getElementById("endorsement_id").value,
    accused_service_info_id: document.getElementById("accused_service_info_id").value,
    accused_present_add_info_id: document.getElementById("accused_present_add_info_id").value,
    accused_permanent_add_info_id: document.getElementById("accused_permanent_add_info_id").value,
  };

  try {
    console.log(data);
    await axios.post(`${API_BASE}/field-office-ers`, data);
    showToast("Record saved successfully", "success");
    e.target.reset();
    loadRecords();
  } catch (err) {
    console.error(err);
    showToast("Error saving record", "danger");
  }
});

// Delete record
async function deleteRecord(id) {
  if (!confirm("Are you sure you want to delete this record?")) return;
  try {
    await axios.delete(`${API_BASE}/field-office-ers/${id}`);
    showToast("Record deleted", "warning");
    loadRecords();
  } catch (err) {
    console.error(err);
    showToast("Error deleting record", "danger");
  }
}

// Initial load
loadDropdowns();
loadRecords();
</script>
</body>
</html>
